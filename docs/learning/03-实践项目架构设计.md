# 实践项目架构设计

> 个人学习项目 - 支持三种模式 + 多模型切换

---

## 项目目标

```
核心目标:
1. 实践三种架构模式（纯前端、纯后端、混合）
2. 验证四代模型（SAM1、SAM2、SAM-HQ、SAM3）
3. 对比性能差异
4. 深度理解 SAM 原理

非目标:
- 企业级生产部署
- 大规模并发处理
- 复杂的用户系统
```

---

## 整体架构设计

### 架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│                     SegmentX 学习平台                             │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                                                             │ │
│  │                   前端 (Vue 3 + Vite)                       │ │
│  │                                                             │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │ │
│  │  │ 模式选择  │  │ 模型选择  │  │ 画布交互  │  │ 性能对比  │  │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │ │
│  │                                                             │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │           模式实现 (Strategy Pattern)               │  │ │
│  │  ├─────────────────────────────────────────────────────┤  │ │
│  │  │  - FrontendOnlyMode  (ONNX Encoder + Decoder)      │  │ │
│  │  │  - BackendOnlyMode   (API: /segment)               │  │ │
│  │  │  - HybridMode        (API: /embedding + Decoder)   │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │                                                             │ │
│  └─────────────┬───────────────────────────────────────────┬─┘ │
│                │                                           │   │
│                │ 模式A: 无请求                             │   │
│                │ 模式B: HTTP API                           │   │
│                │ 模式C: HTTP API                           │   │
│                ▼                                           ▼   │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                                                          │  │
│  │              后端 (Python + FastAPI)                     │  │
│  │                                                          │  │
│  │  ┌────────────────────────────────────────────────────┐ │  │
│  │  │          模型管理器 (Singleton)                     │ │  │
│  │  ├────────────────────────────────────────────────────┤ │  │
│  │  │  - SAM1 Manager  (vit_b / vit_l / vit_h)          │ │  │
│  │  │  - SAM2 Manager  (tiny / small / base+ / large)   │ │  │
│  │  │  - SAM-HQ Manager (vit_b / vit_l / vit_h)         │ │  │
│  │  │  - SAM3 Manager   (848M 统一模型)                  │ │  │
│  │  └────────────────────────────────────────────────────┘ │  │
│  │                                                          │  │
│  │  ┌────────────────────────────────────────────────────┐ │  │
│  │  │                  API Routes                         │ │  │
│  │  ├────────────────────────────────────────────────────┤ │  │
│  │  │  GET  /api/models          (列出可用模型)          │ │  │
│  │  │  POST /api/embedding       (混合模式: 生成嵌入)    │ │  │
│  │  │  POST /api/segment         (纯后端: 完整分割)      │ │  │
│  │  │  POST /api/segment/text    (SAM3: 文本提示)        │ │  │
│  │  │  GET  /api/performance     (性能统计)              │ │  │
│  │  └────────────────────────────────────────────────────┘ │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 目录结构设计

```
SegmentX/
├── frontend/                           # Vue 3 前端
│   ├── src/
│   │   ├── assets/                     # 静态资源
│   │   │   └── styles/
│   │   │       └── main.css
│   │   ├── components/                 # 通用组件
│   │   │   ├── Canvas/
│   │   │   │   ├── DrawCanvas.vue      # 绘图画布
│   │   │   │   ├── MaskLayer.vue       # Mask 叠加层
│   │   │   │   └── InteractionLayer.vue # 交互层（点击）
│   │   │   ├── Controls/
│   │   │   │   ├── ModeSelector.vue    # 模式选择器
│   │   │   │   ├── ModelSelector.vue   # 模型选择器
│   │   │   │   ├── ImageUploader.vue   # 图片上传
│   │   │   │   └── ToolBar.vue         # 工具栏
│   │   │   ├── Performance/
│   │   │   │   ├── MetricsPanel.vue    # 性能指标
│   │   │   │   └── ComparisonChart.vue # 对比图表
│   │   │   └── Common/
│   │   │       ├── Loading.vue
│   │   │       └── ErrorBoundary.vue
│   │   ├── modes/                      # 三种模式实现
│   │   │   ├── base/
│   │   │   │   └── BaseMode.ts         # 基类（定义接口）
│   │   │   ├── frontend-only/
│   │   │   │   ├── FrontendOnlyMode.ts # 纯前端实现
│   │   │   │   ├── OnnxEncoder.ts      # ONNX Encoder 封装
│   │   │   │   ├── OnnxDecoder.ts      # ONNX Decoder 封装
│   │   │   │   └── Preprocessor.ts     # 图像预处理
│   │   │   ├── backend-only/
│   │   │   │   ├── BackendOnlyMode.ts  # 纯后端实现
│   │   │   │   └── ApiClient.ts        # API 调用封装
│   │   │   └── hybrid/
│   │   │       ├── HybridMode.ts       # 混合模式实现
│   │   │       ├── EmbeddingCache.ts   # Embedding 缓存
│   │   │       └── Compressor.ts       # 压缩/解压
│   │   ├── core/                       # 核心功能
│   │   │   ├── canvas/
│   │   │   │   ├── renderer.ts         # Canvas 渲染
│   │   │   │   ├── mask-overlay.ts     # Mask 叠加
│   │   │   │   └── color-picker.ts     # 颜色选择
│   │   │   ├── utils/
│   │   │   │   ├── image.ts            # 图像处理工具
│   │   │   │   ├── rle.ts              # RLE 编解码
│   │   │   │   ├── performance.ts      # 性能监控
│   │   │   │   └── validator.ts        # 数据验证
│   │   │   └── types/
│   │   │       ├── mode.ts             # 模式类型定义
│   │   │       ├── model.ts            # 模型类型定义
│   │   │       └── mask.ts             # Mask 类型定义
│   │   ├── stores/                     # Pinia 状态管理
│   │   │   ├── app.ts                  # 应用全局状态
│   │   │   ├── mode.ts                 # 模式状态
│   │   │   ├── model.ts                # 模型状态
│   │   │   ├── canvas.ts               # 画布状态
│   │   │   └── performance.ts          # 性能统计
│   │   ├── views/                      # 页面视图
│   │   │   ├── Home.vue                # 主页
│   │   │   ├── Workspace.vue           # 工作区（主界面）
│   │   │   ├── Comparison.vue          # 模型对比
│   │   │   └── About.vue               # 关于页面
│   │   ├── router/
│   │   │   └── index.ts                # 路由配置
│   │   ├── config/
│   │   │   ├── models.ts               # 模型配置
│   │   │   ├── modes.ts                # 模式配置
│   │   │   └── api.ts                  # API 配置
│   │   ├── App.vue                     # 根组件
│   │   └── main.ts                     # 入口文件
│   ├── public/
│   │   ├── models/                     # ONNX 模型文件
│   │   │   ├── sam2_encoder_tiny.onnx
│   │   │   ├── sam2_encoder_small.onnx
│   │   │   ├── sam2_encoder_base_plus.onnx
│   │   │   └── sam_decoder.onnx
│   │   └── demo-images/                # 示例图片
│   ├── index.html
│   ├── vite.config.ts
│   ├── tsconfig.json
│   ├── package.json
│   └── pnpm-lock.yaml
│
├── backend/                            # Python 后端
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                     # FastAPI 应用入口
│   │   ├── config.py                   # 配置文件
│   │   ├── api/                        # API 路由
│   │   │   ├── __init__.py
│   │   │   ├── models.py               # GET /api/models
│   │   │   ├── embedding.py            # POST /api/embedding
│   │   │   ├── segment.py              # POST /api/segment
│   │   │   ├── text_segment.py         # POST /api/segment/text
│   │   │   └── performance.py          # GET /api/performance
│   │   ├── models/                     # 模型管理
│   │   │   ├── __init__.py
│   │   │   ├── base.py                 # 基类
│   │   │   ├── sam1_manager.py         # SAM1 管理器
│   │   │   ├── sam2_manager.py         # SAM2 管理器
│   │   │   ├── sam_hq_manager.py       # SAM-HQ 管理器
│   │   │   └── sam3_manager.py         # SAM3 管理器
│   │   ├── core/                       # 核心功能
│   │   │   ├── __init__.py
│   │   │   ├── image_loader.py         # 图片加载
│   │   │   ├── preprocessor.py         # 预处理
│   │   │   ├── postprocessor.py        # 后处理
│   │   │   └── encoder.py              # 编码工具
│   │   ├── utils/                      # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── rle.py                  # RLE 编码
│   │   │   ├── compression.py          # 压缩工具
│   │   │   ├── validator.py            # 验证工具
│   │   │   └── logger.py               # 日志工具
│   │   └── schemas/                    # Pydantic 模型
│   │       ├── __init__.py
│   │       ├── request.py              # 请求模型
│   │       └── response.py             # 响应模型
│   ├── models/                         # PyTorch 模型文件
│   │   ├── .gitkeep
│   │   └── download.sh                 # 模型下载脚本
│   ├── tests/                          # 测试
│   │   ├── __init__.py
│   │   ├── test_api.py
│   │   └── test_models.py
│   ├── requirements.txt                # Python 依赖
│   ├── pyproject.toml                  # Poetry 配置（可选）
│   └── Dockerfile                      # Docker 镜像
│
├── sam/                                # 文档
│   ├── README.md
│   ├── 00-SAM核心原理.md
│   ├── 01-SAM模型演进.md
│   ├── 02-实践架构选择.md
│   ├── 03-实践项目架构设计.md      # 当前文档
│   ├── 04-实施计划.md              # 分步实施指南
│   └── 05-开发指南.md              # 开发规范
│
├── scripts/                            # 工具脚本
│   ├── setup.sh                        # 环境搭建
│   ├── download-models.sh              # 下载模型
│   ├── dev.sh                          # 开发启动
│   └── build.sh                        # 构建脚本
│
├── docker-compose.yml                  # Docker 编排
├── .gitignore
└── README.md                           # 项目总 README
```

---

## 核心设计理念

### 1. 策略模式（三种模式切换）

```typescript
// modes/base/BaseMode.ts

export interface ModeConfig {
  name: string;
  displayName: string;
  description: string;
  requirements: string[];
}

export interface Point {
  x: number;
  y: number;
  type: 0 | 1; // 0=背景, 1=前景
}

export interface MaskResult {
  mask: ImageData;
  score: number;
  timeMs: number;
}

export abstract class BaseMode {
  abstract config: ModeConfig;
  
  /**
   * 初始化模式（加载模型等）
   */
  abstract initialize(): Promise<void>;
  
  /**
   * 加载图片（生成 Embedding）
   */
  abstract loadImage(imageData: ImageData): Promise<void>;
  
  /**
   * 分割（基于点击）
   */
  abstract segment(points: Point[]): Promise<MaskResult>;
  
  /**
   * 清理资源
   */
  abstract cleanup(): Promise<void>;
  
  /**
   * 获取模式信息
   */
  getInfo(): ModeConfig {
    return this.config;
  }
}
```

### 2. 模型管理器（统一接口）

```typescript
// core/types/model.ts

export enum ModelFamily {
  SAM1 = 'sam1',
  SAM2 = 'sam2',
  SAM_HQ = 'sam_hq',
  SAM3 = 'sam3'
}

export interface ModelConfig {
  id: string;
  family: ModelFamily;
  name: string;
  size: number; // MB
  params: number; // Million
  supportedModes: ('frontend' | 'backend' | 'hybrid')[];
  hasONNX: boolean;
  features: string[];
}

export const MODEL_REGISTRY: Record<string, ModelConfig> = {
  'sam1_vit_b': {
    id: 'sam1_vit_b',
    family: ModelFamily.SAM1,
    name: 'SAM1 ViT-B',
    size: 375,
    params: 91,
    supportedModes: ['backend', 'hybrid'],
    hasONNX: false,
    features: ['点击', '边界框']
  },
  'sam2_tiny': {
    id: 'sam2_tiny',
    family: ModelFamily.SAM2,
    name: 'SAM2 Tiny',
    size: 39,
    params: 38.9,
    supportedModes: ['frontend', 'backend', 'hybrid'],
    hasONNX: true,
    features: ['点击', '边界框', '视频']
  },
  'sam3': {
    id: 'sam3',
    family: ModelFamily.SAM3,
    name: 'SAM3',
    size: 3200,
    params: 848,
    supportedModes: ['backend'],
    hasONNX: false,
    features: ['点击', '边界框', '文本', '示例']
  }
  // ... 其他模型
};
```

### 3. 性能监控（对比分析）

```typescript
// core/utils/performance.ts

export interface PerformanceMetrics {
  mode: string;
  model: string;
  
  // 时间指标
  loadModelTime?: number;      // 模型加载时间
  encodeImageTime?: number;    // 图片编码时间
  decodeTime?: number;         // 点击解码时间
  totalTime: number;           // 总耗时
  
  // 网络指标
  requestCount?: number;       // 请求次数
  networkTime?: number;        // 网络耗时
  dataTransferred?: number;    // 传输数据量(KB)
  
  // 内存指标
  memoryUsed?: number;         // 内存占用(MB)
  
  // 质量指标
  maskQuality?: number;        // Mask 质量分数
}

export class PerformanceMonitor {
  private metrics: PerformanceMetrics[] = [];
  
  startSession(mode: string, model: string): string {
    const sessionId = `${Date.now()}_${Math.random()}`;
    // ... 记录开始
    return sessionId;
  }
  
  recordMetric(sessionId: string, metric: Partial<PerformanceMetrics>) {
    // ... 记录指标
  }
  
  getComparison(mode1: string, mode2: string) {
    // ... 对比分析
  }
  
  export() {
    // 导出 CSV / JSON
  }
}
```

---

## 技术栈详细规划

### 前端技术栈

```json
{
  "dependencies": {
    "vue": "^3.4.0",
    "vue-router": "^4.2.0",
    "pinia": "^2.1.0",
    "onnxruntime-web": "^1.17.0",
    "pako": "^2.1.0",
    "chart.js": "^4.4.0",
    "vue-chartjs": "^5.3.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.0.0",
    "vite": "^5.0.0",
    "typescript": "^5.3.0",
    "sass": "^1.69.0",
    "@types/pako": "^2.0.0"
  }
}
```

**核心库说明**

| 库 | 用途 | 版本 |
|---|------|------|
| Vue 3 | 前端框架 | 3.4+ |
| Pinia | 状态管理 | 2.1+ |
| ONNX Runtime Web | 前端推理 | 1.17+ |
| pako | gzip 压缩/解压 | 2.1+ |
| Chart.js | 性能图表 | 4.4+ |

### 后端技术栈

```txt
# requirements.txt

# Web 框架
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-multipart==0.0.6

# SAM 模型
torch==2.2.0
torchvision==0.17.0
segment-anything==1.0        # SAM1
git+https://github.com/facebookresearch/sam2.git  # SAM2
git+https://github.com/SysCV/sam-hq.git           # SAM-HQ
git+https://github.com/facebookresearch/sam3.git  # SAM3

# 图像处理
opencv-python==4.9.0
Pillow==10.2.0
numpy==1.26.0

# 工具
pydantic==2.5.0
python-dotenv==1.0.0
aiofiles==23.2.1
```

---

## 关键技术实现

### 1. 前端模式切换

```typescript
// stores/mode.ts

import { defineStore } from 'pinia';
import { BaseMode } from '@/modes/base/BaseMode';
import { FrontendOnlyMode } from '@/modes/frontend-only/FrontendOnlyMode';
import { BackendOnlyMode } from '@/modes/backend-only/BackendOnlyMode';
import { HybridMode } from '@/modes/hybrid/HybridMode';

export const useModeStore = defineStore('mode', {
  state: () => ({
    currentMode: null as BaseMode | null,
    modeType: 'hybrid' as 'frontend' | 'backend' | 'hybrid',
    isInitialized: false,
    isLoading: false
  }),
  
  actions: {
    async switchMode(modeType: 'frontend' | 'backend' | 'hybrid') {
      // 清理旧模式
      if (this.currentMode) {
        await this.currentMode.cleanup();
      }
      
      // 创建新模式
      this.modeType = modeType;
      switch (modeType) {
        case 'frontend':
          this.currentMode = new FrontendOnlyMode();
          break;
        case 'backend':
          this.currentMode = new BackendOnlyMode();
          break;
        case 'hybrid':
          this.currentMode = new HybridMode();
          break;
      }
      
      // 初始化
      this.isLoading = true;
      try {
        await this.currentMode.initialize();
        this.isInitialized = true;
      } catch (error) {
        console.error('模式初始化失败:', error);
        throw error;
      } finally {
        this.isLoading = false;
      }
    }
  }
});
```

### 2. 后端模型管理

```python
# backend/app/models/base.py

from abc import ABC, abstractmethod
from typing import Optional, Tuple
import numpy as np

class BaseModelManager(ABC):
    """模型管理器基类"""
    
    def __init__(self):
        self.model = None
        self.predictor = None
        self.is_loaded = False
    
    @abstractmethod
    def load_model(self, checkpoint_path: str, device: str = "cuda"):
        """加载模型"""
        pass
    
    @abstractmethod
    def generate_embedding(self, image: np.ndarray) -> np.ndarray:
        """生成 Embedding"""
        pass
    
    @abstractmethod
    def segment(
        self,
        image: np.ndarray,
        points: np.ndarray,
        labels: np.ndarray
    ) -> Tuple[np.ndarray, np.ndarray]:
        """分割（返回 masks, scores）"""
        pass
    
    def cleanup(self):
        """清理资源"""
        if self.model is not None:
            del self.model
            self.model = None
        if self.predictor is not None:
            del self.predictor
            self.predictor = None
        self.is_loaded = False
```

```python
# backend/app/models/sam1_manager.py

from segment_anything import sam_model_registry, SamPredictor
import torch
from .base import BaseModelManager

class SAM1Manager(BaseModelManager):
    """SAM1 模型管理器"""
    
    def load_model(self, checkpoint_path: str, model_type: str = "vit_b", device: str = "cuda"):
        print(f"加载 SAM1 {model_type}...")
        self.model = sam_model_registry[model_type](checkpoint=checkpoint_path)
        self.model.to(device)
        self.model.eval()
        self.predictor = SamPredictor(self.model)
        self.is_loaded = True
        print(f"SAM1 {model_type} 加载完成")
    
    def generate_embedding(self, image: np.ndarray) -> np.ndarray:
        with torch.no_grad():
            self.predictor.set_image(image)
            embedding = self.predictor.get_image_embedding()
            return embedding.cpu().numpy()
    
    def segment(self, image: np.ndarray, points: np.ndarray, labels: np.ndarray):
        self.predictor.set_image(image)
        masks, scores, _ = self.predictor.predict(
            point_coords=points,
            point_labels=labels,
            multimask_output=True
        )
        return masks, scores
```

### 3. API 设计

```python
# backend/app/api/embedding.py

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
import numpy as np
import gzip
import base64

router = APIRouter(prefix="/api", tags=["embedding"])

class EmbeddingRequest(BaseModel):
    image_url: str
    model: str = "sam1_vit_b"

class EmbeddingResponse(BaseModel):
    embedding: str  # base64(gzip(float32_array))
    shape: list[int]
    original_size: list[int]  # [H, W]
    compressed_size: int
    model: str

@router.post("/embedding", response_model=EmbeddingResponse)
async def create_embedding(request: EmbeddingRequest):
    """
    生成图片 Embedding（混合模式使用）
    """
    try:
        # 1. 加载图片
        image = await load_image_from_url(request.image_url)
        
        # 2. 获取模型管理器
        manager = model_registry.get(request.model)
        if not manager or not manager.is_loaded:
            raise HTTPException(status_code=400, detail=f"模型 {request.model} 未加载")
        
        # 3. 生成 Embedding
        embedding = manager.generate_embedding(image)
        
        # 4. 压缩
        embedding_bytes = embedding.astype(np.float32).tobytes()
        compressed = gzip.compress(embedding_bytes, compresslevel=6)
        encoded = base64.b64encode(compressed).decode()
        
        return EmbeddingResponse(
            embedding=encoded,
            shape=list(embedding.shape),
            original_size=[image.shape[0], image.shape[1]],
            compressed_size=len(compressed),
            model=request.model
        )
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

## 开发规范

### 1. 代码规范

**TypeScript (ESLint + Prettier)**

```json
// .eslintrc.json
{
  "extends": [
    "eslint:recommended",
    "plugin:vue/vue3-recommended",
    "@vue/typescript/recommended"
  ],
  "rules": {
    "vue/multi-word-component-names": "off",
    "@typescript-eslint/no-explicit-any": "warn"
  }
}
```

**Python (Black + Flake8)**

```ini
# .flake8
[flake8]
max-line-length = 100
exclude = .git,__pycache__,venv
ignore = E203,W503
```

### 2. Git 规范

**分支策略**

```
main                    # 主分支（稳定）
├── develop            # 开发分支
│   ├── feature/xxx    # 功能分支
│   ├── fix/xxx        # 修复分支
│   └── docs/xxx       # 文档分支
```

**提交规范**

```
feat: 新功能
fix: 修复
docs: 文档
style: 格式
refactor: 重构
test: 测试
chore: 构建/工具

示例:
feat(frontend): 实现纯前端模式
fix(backend): 修复 SAM3 文本提示 API
docs(sam): 更新架构设计文档
```

---

## 性能优化策略

### 1. 前端优化

```typescript
// 1. ONNX 模型缓存
const modelCache = new Map<string, ort.InferenceSession>();

async function getOrCreateSession(modelPath: string) {
  if (!modelCache.has(modelPath)) {
    const session = await ort.InferenceSession.create(modelPath);
    modelCache.set(modelPath, session);
  }
  return modelCache.get(modelPath)!;
}

// 2. Embedding 缓存（IndexedDB）
import { openDB } from 'idb';

const db = await openDB('sam-cache', 1, {
  upgrade(db) {
    db.createObjectStore('embeddings');
  }
});

async function cacheEmbedding(imageHash: string, embedding: Float32Array) {
  await db.put('embeddings', embedding, imageHash);
}

// 3. Web Worker 处理
// worker.ts
self.onmessage = async (e) => {
  const { type, data } = e.data;
  if (type === 'preprocess') {
    const result = preprocessImage(data);
    self.postMessage({ type: 'preprocessed', result });
  }
};
```

### 2. 后端优化

```python
# 1. 模型预加载（启动时）
@app.on_event("startup")
async def startup_event():
    print("预加载默认模型...")
    model_registry.load("sam2_small")
    print("模型预加载完成")

# 2. Embedding 缓存（Redis）
import redis
import hashlib

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_image_hash(image: np.ndarray) -> str:
    return hashlib.md5(image.tobytes()).hexdigest()

def cache_embedding(image_hash: str, embedding: np.ndarray):
    redis_client.setex(
        f"embedding:{image_hash}",
        3600,  # 1小时过期
        embedding.tobytes()
    )

# 3. 批处理支持
@router.post("/api/segment/batch")
async def segment_batch(requests: List[SegmentRequest]):
    results = []
    for req in requests:
        result = await segment_single(req)
        results.append(result)
    return results
```

---

## 下一步

阅读实施计划：
- [04-实施计划](./04-实施计划.md) - 分步实施指南（7天计划）
